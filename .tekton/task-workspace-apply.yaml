apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: test-bom
spec:
  params:
    - name: ibmcloud-apikey-secret-key
      description: field in the secret that contains the api key used to login to ibmcloud
      default: apikey
    - name: continuous-delivery-context-secret
      description: Reference name for the secret resource
      default: "secure-properties"
    - name: TOOLCHAIN_ID
      description: the workspace id
  workspaces:
    - name: artifacts
      mountPath: /artifacts
  steps:
    - name: bom-cli-test
      image: docker:19.03.14-dind
      env:
        - name: API_KEY
          valueFrom:
            secretKeyRef:
              name: $(params.continuous-delivery-context-secret)
              key: $(params.ibmcloud-apikey-secret-key)
              optional: true
        - name: TOOLCHAIN_ID
          value: $(params.TOOLCHAIN_ID)
        # Docker config
        - name: DOCKER_HOST
          value: "tcp://localhost:2376"
        - name: DOCKER_TLS_VERIFY
          value: "1"
        - name: DOCKER_CERT_PATH
          value: /certs/client
        - name: DOCKER_CONFIG
          value: /steps
      command: ["/bin/sh", "-c"]
      args:
        - |
          #!/bin/bash

          export TOOLCHAIN_ID=$TOOLCHAIN_ID


          echo "Installing golang"
          apk add --no-cache go
          echo "Golang installed successfully"
          echo "Installing jq"
          apk add jq
          echo "jq installed successfully"

          docker pull davidlopez0912/test-plugin:v1

          echo -e "Installing ibmcloud cli..."
          wget https://clis.cloud.ibm.com/download/bluemix-cli/1.2.0/linux64 -O ibmcloud-cli.tar.gz
          tar xvf ibmcloud-cli.tar.gz
          rm ibmcloud-cli.tar.gz
          Bluemix_CLI/bin/ibmcloud --version
          Bluemix_CLI/bin/ibmcloud plugin install container-registry
          echo -e "ibmcloud cli installed successfully"
          echo "Fetching users's token"
          API_ENDPOINT="https://test.cloud.ibm.com"
          Bluemix_CLI/bin/ibmcloud config --check-version false
          Bluemix_CLI/bin/ibmcloud login -a $API_ENDPOINT --no-region --apikey $API_KEY
          echo "Successfully logged into ibmcloud"
          export IBM_CLOUD_BEARER=$(Bluemix_CLI/bin/ibmcloud iam oauth-tokens --output JSON | jq -r '.iam_token' | awk '{ print $2 }')
          IAM_AUTH_TOKEN=$IBM_CLOUD_BEARER
          export IAM_AUTH_TOKEN

          docker run davidlopez0912/test-plugin:v1 /tmp/cli-cra-plugin/runTest.sh $TOOLCHAIN_ID $API_KEY
      volumeMounts:
        - mountPath: /steps
          name: steps-volume
        - mountPath: /certs/client
          name: dind-certs
  sidecars:
    - image: docker:19.03.14-dind
      name: server
      securityContext:
        privileged: true
      env:
        - name: DOCKER_TLS_CERTDIR
          value: /certs
      volumeMounts:
        - mountPath: /certs/client
          name: dind-certs
      readinessProbe:
        periodSeconds: 1
        exec:
          command: ["ls", "/certs/client/ca.pem"]
  volumes:
    - name: steps-volume
      emptyDir: {}
    - name: dind-certs
      emptyDir: {}
